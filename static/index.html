<!DOCTYPE html>
<html>

<head>
  <title>Java Playground</title>
  <style>
    html,
    body {
      height: 100%;
    }

    body {
      box-sizing: border-box;
      min-width: 720px;
      display: flex;
      flex-direction: column;
      padding: 0;
      margin: 0;
    }

    section#header {
      background-color: #ace;
      padding: 8px;
    }

    #header button {
      padding: 2px 8px;
    }

    section#content {
      height: 100vh;
      overflow: hidden;
    }

    #left,
    #right {
      box-sizing: border-box;
      padding: 8px;
    }

    #left {
      padding-right: 0;
    }

    #right {
      padding-left: 0;
    }

    #rbot {
      display: flex;
      flex-direction: column;
    }

    #editor,
    #output,
    #logs,
    #stdin {
      font: 12px/normal Monaco, Consolas, monospace;
      box-sizing: border-box;
      width: 100%;
    }

    #editor,
    #output,
    #logs {
      border: 1px solid lightgray;
      height: 100%;
      margin: 0;
    }

    #output,
    #logs {
      padding: 4px;
      overflow: auto;
    }

    #stdin {
      margin-top: 8px;
      padding: 4px;
    }

    .hsplit,
    .vsplit {
      box-sizing: border-box;
    }

    .gutter {
      background-color: transparent;
      background-repeat: no-repeat;
      background-position: 50%;
    }

    .gutter.gutter-vertical {
      cursor: row-resize;
    }

    .gutter.gutter-horizontal {
      cursor: col-resize;
    }

    .hsplit,
    .gutter.gutter-horizontal {
      height: 100%;
      float: left;
    }
  </style>
<script src="/js/socket.io.slim.js"></script>
</head>

<body>
  <section id="header">
    <button id="compile" disabled>Compile &amp; Execute</button>
    <button id="kill" disabled>Stop</button>
    <button style="float: right" onclick="window.open('#')">New</button>
  </section>
  <section id="content">
    <div class="hsplit" id="left">
      <div id="editor"></div>
    </div>
    <div class="hsplit" id="right">
      <div class="vsplit" id="rtop">
        <pre id="logs">Connecting to compiler backend...</pre>
      </div>
      <div class="vsplit" id="rbot">
        <pre id="output">Program output will show up here.</pre>
        <input type="text" id="stdin" placeholder="Input" disabled />
      </div>
    </div>
  </section>
  <script src="/js/ace/ace.js"></script>
  <script>
    const sourceTmpl = "public class Test {\n    public static void main(String[] args) {\n    }\n}";
    const storeOk = typeof(Storage) !== "undefined";
    function initIndex() {
      let idx = storeOk && +localStorage.next || 0;
      let bang = window.location.hash.substr(2);
      if (/^[0-7]$/.test(bang)) {
        return +bang;
      } else {
        if (storeOk) {
          localStorage.next = (idx + 1) % 8;
          delete localStorage[localStorage.next];
        }
        history.replaceState('', document.title, window.location.pathname + "#!" + idx);
        return idx;
      }
    }
    const srcIndex = initIndex();
    function getSource() {
      return storeOk && localStorage[srcIndex] || sourceTmpl;
    }
    function setSource(source) {
      if (storeOk) {
        localStorage[srcIndex] = source;
      }
    }
    const editor = ace.edit("editor");
    editor.setTheme("ace/theme/tomorrow");
    editor.session.setMode("ace/mode/java");
    editor.session.doc.setNewLineMode("unix");
    editor.setValue(getSource(), 1);

    const log = document.getElementById("logs");
    const out = document.getElementById("output");

    function htmlEscape(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    var log_pos = 0;
    function logClear() {
      log.innerHTML = "";
      log_pos = 0;
    }
    function logAppend(str, is_volatile) {
      log.innerHTML = log.innerHTML.substring(0, log_pos) + htmlEscape(str);
      if (!is_volatile) {
        log_pos = log.innerHTML.length;
      }
    }
    function outClear() {
      out.innerHTML = "";
    }
    function outAppend(str) {
      out.innerHTML += htmlEscape(str);
    }

    const compile_button = document.getElementById("compile");
    const kill_button = document.getElementById("kill");
    const stdin_input = document.getElementById("stdin");

    const socket = io("/compiler");
    socket.on('connect', function() {
      logAppend("Click \"Compile & Execute\" when ready.", true);
      compile_button.disabled = false;
      kill_button.disabled = true;
      stdin_input.disabled = true;
    });
    socket.on('disconnect', function() {
      logClear();
      logAppend("Connection with compiler lost. Please rerun the backend.", true);
      compile_button.disabled = true;
      kill_button.disabled = true;
      stdin_input.disabled = true;
    });
    socket.on('started', function(msg) {
      logAppend("Compiling...", true);
      kill_button.disabled = false;
    });
    socket.on('compiled', function(msg) {
      if (msg.ecode == 0) {
        if (msg.logs) {
          logAppend("Compiled with logs:\n" + msg.logs, false);
        } else {
          logAppend("Compiled successfully.\n", false);
        }
        logAppend("Executing...", true);
      } else if (msg.ecode == null) {
        logAppend("Compilation failed. Please try again...\n", false);
      } else if (msg.logs) {
        logAppend("Compiler reported errors:\n" + msg.logs, false);
      } else {
        logAppend("Compiler stopped!\n", false);
      }
      stdin_input.disabled = false;
      stdin_input.focus();
    });
    socket.on('stdout', function(msg) {
      outAppend(msg.data);
      out.scrollTop = out.scrollHeight;
    });
    socket.on('stderr', function(msg) {
      outAppend(msg.data);
      out.scrollTop = out.scrollHeight;
    });
    socket.on('stdin_ack', function(msg) {
      outAppend(msg.data);
      out.scrollTop = out.scrollHeight;
    });
    socket.on('done', function(msg) {
      if (msg.ecode == 0) {
        logAppend("Execution completed.\n", false);
      } else if (msg.ecode !== null) {
        logAppend("Execution stopped. [" + msg.ecode + "]\n", false);
      }
      compile_button.disabled = false;
      kill_button.disabled = true;
      stdin_input.disabled = true;
      editor.focus();
    });

    compile_button.onclick = function(e) {
      let source = editor.getValue();
      logClear();
      outClear();
      logAppend("Compilation requested...", true);
      socket.emit("compile", source);
      compile_button.disabled = true;
      setSource(source);
    }
    kill_button.onclick = function(e) {
      logAppend("Trying to stop...", true);
      socket.emit('kill', null);
      kill_button.disabled = true;
    }
    stdin_input.onkeypress = function(e) {
      if (e.keyCode == 13) {
        socket.emit('stdin', stdin_input.value + "\n");
        stdin_input.value = "";
      }
    }
    window.onbeforeunload = function(e) {
      setSource(editor.getValue());
      socket.close();
    }
  </script>
  <script src="/js/split.min.js"></script>
  <script>
    Split(['#left', '#right'], {
      gutterSize: 8
    })
    Split(['#rtop', '#rbot'], {
      sizes: [40, 60],
      direction: 'vertical',
      gutterSize: 8
    })
  </script>
</body>

</html>
