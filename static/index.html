<!DOCTYPE html>
<html>

<head>
  <title>Java Playground</title>
  <style>
    html,
    body {
      height: 100%;
    }

    body {
      box-sizing: border-box;
      min-width: 720px;
      display: flex;
      flex-direction: column;
      padding: 0;
      margin: 0;
    }

    section#header {
      background-color: #ace;
      padding: 8px;
    }

    #header button {
      padding: 2px 8px;
    }

    section#content {
      height: 100vh;
      overflow: hidden;
    }

    #left,
    #right {
      box-sizing: border-box;
      padding: 8px;
    }

    #left {
      padding-right: 0;
    }

    #right {
      padding-left: 0;
    }

    #rbot {
      display: flex;
      flex-direction: column;
    }

    #editor,
    #output,
    #logs,
    #stdin {
      font: 12px/normal Monaco, Consolas, monospace;
      box-sizing: border-box;
      width: 100%;
    }

    #editor,
    #output,
    #logs {
      border: 1px solid lightgray;
      height: 100%;
      margin: 0;
    }

    #output,
    #logs {
      padding: 4px;
      overflow: auto;
    }

    #stdin {
      margin-top: 8px;
      padding: 4px;
    }

    .hsplit,
    .vsplit {
      box-sizing: border-box;
    }

    .gutter {
      background-color: transparent;
      background-repeat: no-repeat;
      background-position: 50%;
    }

    .gutter.gutter-vertical {
      cursor: row-resize;
    }

    .gutter.gutter-horizontal {
      cursor: col-resize;
    }

    .hsplit,
    .gutter.gutter-horizontal {
      height: 100%;
      float: left;
    }
  </style>
<script src="/js/socket.io.slim.js"></script>
</head>

<body>
  <section id="header">
    <button id="compile">Compile &amp; Run</button>
    <button id="kill" disabled>Stop</button>
  </section>
  <section id="content">
    <div class="hsplit" id="left">
      <pre id="editor"></pre>
    </div>
    <div class="hsplit" id="right">
      <div class="vsplit" id="rtop">
        <pre id="logs">Click "Compile &amp; Run" when ready.</pre>
      </div>
      <div class="vsplit" id="rbot">
        <pre id="output">Program output will show up here.</pre>
        <input type="text" id="stdin" placeholder="Input" disabled />
      </div>
    </div>
  </section>
  <script src="/js/ace/ace.js"></script>
  <script>
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/tomorrow");
    editor.session.setMode("ace/mode/java");
    var showCode = "public class Test {\n}";
    if (typeof(Storage) === "undefined") {
      alert("The code you write will not be saved!");
    } else if (localStorage.javaSource) {
      showCode = localStorage.javaSource;
    } else {
      localStorage.javaSource = showCode;
    }
    editor.setValue(showCode, 1);

    var log = document.getElementById("logs");
    var out = document.getElementById("output");

    var compile_button = document.getElementById("compile");
    var kill_button = document.getElementById("kill");
    var stdin_input = document.getElementById("stdin");

    var socket = io("/compiler");
    socket.on('started', function(msg) {
      log.innerText += "Compiling...\n";
      kill_button.disabled = false;
    });
    socket.on('compiled', function(msg) {
      if (msg.ecode == 0) {
        log.innerText += "Compiled without errors";
        if (msg.logs) {
          log.innerText += ", with logs:\n";
          log.innerText += msg.logs;
        } else {
          log.innerText += ".\n";
        }
        if (!msg.done) {
          log.innerText += "Executing...\n";
        }
      } else {
        log.innerText += "Compiler exited with code " + msg.ecode + ".\n";
        log.innerText += msg.logs;
      }
      stdin_input.disabled = false;
      stdin_input.focus();
    });
    socket.on('stdout', function(msg) {
      out.innerText += msg.data;
    });
    socket.on('stderr', function(msg) {
      out.innerText += msg.data;
    });
    socket.on('stdin_ack', function(msg) {
      out.innerText += msg.data;
    });
    socket.on('done', function(msg) {
      log.innerText += "Program exited with code " + msg.ecode + ".\n";
      compile_button.disabled = false;
      kill_button.disabled = true;
      stdin_input.disabled = true;
      editor.focus();
    });

    compile_button.onclick = function(e) {
      log.innerText = "";
      out.innerText = "";
      socket.emit('compile', editor.getValue());
      compile_button.disabled = true;
    }
    kill_button.onclick = function(e) {
      log.innerText += "Trying to kill the running process...\n";
      socket.emit('kill', null);
      kill_button.disabled = true;
    }
    stdin_input.onkeypress = function(e) {
      if (e.keyCode == 13) {
        socket.emit('stdin', stdin_input.value + "\n");
        stdin_input.value = "";
      }
    }
    window.onbeforeunload = function(e) {
      if (typeof(Storage) !== "undefined") {
        localStorage.javaSource = editor.getValue();
      }
    }
  </script>
  <script src="/js/split.min.js"></script>
  <script>
    Split(['#left', '#right'], {
      gutterSize: 8
    })
    Split(['#rtop', '#rbot'], {
      direction: 'vertical',
      gutterSize: 8
    })
  </script>
</body>

</html>
